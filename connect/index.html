<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abbas Uddin | Live Chat</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

  <style>
    :root {
      --bg-dark: #1A1C22;
      --neon-cyan: #03dac6;
      --neon-pink: #ff0266;
      --glass-bg: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #e0e0e0;
      --msg-me: rgba(3, 218, 198, 0.15);
      --msg-other: rgba(255, 255, 255, 0.05);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Space Grotesk", sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      height: 100svh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Backgrounds */
    .bg-glow {
      position: fixed; width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(3, 218, 198, 0.05) 0%, transparent 70%);
      border-radius: 50%; top: -200px; left: -200px; z-index: -1; pointer-events: none;
    }
    .bg-glow-2 {
      position: fixed; width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(255, 2, 102, 0.05) 0%, transparent 70%);
      border-radius: 50%; bottom: -100px; right: -100px; z-index: -1; pointer-events: none;
    }

    .container {
      width: 100%; max-width: 600px; padding: 1.5rem;
      display: flex; flex-direction: column; height: 100%;
    }

    /* --- APP HEADER --- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding: 0.5rem;
    }

    .profile-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar-frame {
      width: 45px; height: 45px;
      border-radius: 50%;
      border: 2px solid var(--neon-cyan);
      box-shadow: 0 0 20px rgba(3, 218, 198, 0.3);
      background: linear-gradient(135deg, var(--neon-cyan), var(--glass-border));
    }

    .avatar-frame img {
      width: 100%; height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    h1 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    .status-badge {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.75rem; color: var(--neon-cyan);
      background: rgba(3, 218, 198, 0.1); padding: 6px 12px;
      border-radius: 20px; border: 1px solid rgba(3, 218, 198, 0.2);
      transition: 0.3s;
    }
    
    .status-badge.offline { color: #ff4444; border-color: #ff4444; background: rgba(255, 68, 68, 0.1); }
    .status-badge.offline .dot { background: #ff4444; animation: none; }

    .dot {
      width: 6px; height: 6px; background: var(--neon-cyan);
      border-radius: 50%; animation: pulse 2s infinite;
    }

    /* --- CHAT AREA --- */
    .chat-box {
      flex: 1;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      display: flex; flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    .messages {
      flex: 1; padding: 1.5rem;
      overflow-y: auto;
      display: flex; flex-direction: column; gap: 1rem;
      scroll-behavior: smooth;
    }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

    .msg {
      max-width: 80%; padding: 10px 14px;
      border-radius: 14px; font-size: 0.95rem; line-height: 1.4;
      position: relative; word-wrap: break-word;
      animation: slideIn 0.3s ease;
    }

    .msg-other {
      align-self: flex-start;
      background: var(--msg-other);
      border: 1px solid var(--glass-border);
      border-bottom-left-radius: 2px;
      color: #ccc;
    }

    .msg-me {
      align-self: flex-end;
      background: var(--msg-me);
      border: 1px solid rgba(3, 218, 198, 0.3);
      border-bottom-right-radius: 2px;
      color: #fff;
    }

    .time { font-size: 0.65rem; opacity: 0.5; margin-top: 4px; display: block; text-align: right; }

    /* --- INPUT AREA --- */
    .input-row {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid var(--glass-border);
      display: flex; gap: 10px;
    }

    input {
      flex: 1; background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      padding: 12px 16px; border-radius: 12px;
      color: #fff; outline: none; transition: 0.3s;
    }
    input:focus { border-color: var(--neon-cyan); background: rgba(3, 218, 198, 0.05); }

    button {
      background: var(--neon-cyan); color: #000; border: none;
      width: 40px; height: 40px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.3s;
    }
    button:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(3, 218, 198, 0.4); }
    button:disabled { background: #444; cursor: default; transform: none; box-shadow: none; }

    /* Back Link */
    .nav-back {
      position: absolute; top: 1rem; left: 1rem;
      display: none; /* Hidden on mobile to save space */
    }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(3, 218, 198, 0); } 100% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-glow"></div>
  <div class="bg-glow-2"></div>

  <div class="container">
    
    <header>
      <div class="profile-group">
        <a href="/" class="avatar-frame">
          <img src="/img/abbasuddin.webp" alt="Abbas">
        </a>
        <h1>Abbas Uddin</h1>
      </div>
      <div id="statusBadge" class="status-badge offline">
        <div class="dot"></div>
        <span id="statusText">Offline</span>
      </div>
    </header>

    <div class="chat-box">
      <div class="messages" id="msgList">
        <div class="msg msg-other">
          <img src="/img/waving-hand-svgrepo-com.svg" style="height: 1rem; display:inline;"/> Welcome! Send a message to chat live. I will get back to you shortly.
          <span class="time">System</span>
        </div>
      </div>

      <div class="input-row">
        <input type="text" id="msgInput" placeholder="Connecting..." disabled autocomplete="off">
        <button id="sendBtn" disabled><i data-lucide="send"></i></button>
      </div>
    </div>

  </div>

  <script>
    lucide.createIcons();

    // 1. CONFIGURATION
    const EMAIL_SERVICE = 'service_ovmjtxd';
    const EMAIL_TEMPLATE = 'template_pci5pcv';
    const PUBLIC_KEY = 'Z35F2ocDmFcEAPZdS';
    
    // UPDATE URL
    const SERVER_URL = "https://abbas-chat-server.onrender.com"; 

    // LOCAL STORAGE CONFIG
    const STORAGE_KEY = 'abbas_chat_history_v1';
    const EXPIRATION_MS = 30 * 60 * 1000; // 30 Minutes

    (function(){ emailjs.init(PUBLIC_KEY); })();

    const socket = io(SERVER_URL, { autoConnect: true, reconnection: true });

    // DOM Elements
    const msgList = document.getElementById('msgList');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');

    let hasNotified = false;

    // --- HISTORY MANAGER ---
    function loadHistory() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;

      let history = JSON.parse(raw);
      const now = Date.now();

      // Filter out messages older than 30 mins
      const validHistory = history.filter(item => (now - item.timestamp) < EXPIRATION_MS);
      
      // Update storage with cleaned list
      if (validHistory.length !== history.length) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(validHistory));
      }

      // Render valid messages
      validHistory.forEach(data => {
        addMessageToUI(data.text, data.type, data.isAdmin, data.timeStr);
      });
    }

    function saveMessage(text, type, isAdmin, timeStr) {
      const raw = localStorage.getItem(STORAGE_KEY);
      let history = raw ? JSON.parse(raw) : [];
      
      history.push({
        text, 
        type, 
        isAdmin, 
        timeStr, 
        timestamp: Date.now() 
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // --- SOCKET HANDLERS ---
    socket.on('connect', () => {
      statusBadge.classList.remove('offline');
      statusText.textContent = "Online";
      msgInput.disabled = false;
      sendBtn.disabled = false;
      msgInput.placeholder = "Type a message...";
    });

    socket.on('disconnect', () => {
      statusBadge.classList.add('offline');
      statusText.textContent = "Reconnecting...";
      msgInput.disabled = true;
      sendBtn.disabled = true;
    });

    // --- UPDATED MESSAGE LISTENER ---
    socket.on('chat message', (data) => {
      // Check if message is from Admin or Me
      // We assume if it's NOT admin, it's the current user (simplification for 1-on-1)
      
      let type = 'other'; // Default to "Other/System"
      
      if (data.isAdmin) {
        type = 'other'; // Admin messages appear on left
      } else if (data.senderId === socket.id) {
        type = 'me';    // My messages appear on right
      } else {
        // If multiple users are online, this prevents seeing other visitors' messages

        return; // Ignore messages from other non-admin visitors
      }

      const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      addMessageToUI(data.text, type, data.isAdmin, timeStr);
      saveMessage(data.text, type, data.isAdmin, timeStr);
    });

    function addMessageToUI(text, type, isAdmin, timeStr = null) {
      const div = document.createElement('div');
      div.className = `msg msg-${type}`;
      
      const time = timeStr || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const label = isAdmin ? '<strong>Abbas Uddin</strong><br>' : '';

      div.innerHTML = `${label}${text}<span class="time">${time}</span>`;
      msgList.appendChild(div);
      msgList.scrollTop = msgList.scrollHeight;
    }

    // --- UPDATED NOTIFICATION ---
    function notifyAdmin(text) {
      if (hasNotified) return; 

      const params = {
        name: "Live Chat User",
        email: "alert@abbasuddin.com",
        subject: "ðŸ”´ Live Chat Active",
        // DASHBOARD LINK HERE
        message: `User says: "${text}" \n\n Reply Live Here: https://abbasuddin.com/connect/admin.html`
      };

      emailjs.send(EMAIL_SERVICE, EMAIL_TEMPLATE, params)
        .then(() => { console.log("Admin Alerted"); hasNotified = true; });
    }

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      // Send Object with ID
      socket.emit('chat message', {
        text: text,
        senderId: socket.id,
        isAdmin: false
      });
      
      notifyAdmin(text);

      msgInput.value = '';
      msgInput.focus();
    }

    // --- INITIALIZE ---
    loadHistory(); // Load previous chats on startup

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

  </script>

</body>
</html>
